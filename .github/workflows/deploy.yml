name: Deploy â€” Backend API

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Write .env.production to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script_stop: true
          envs: ENV_PRODUCTION
          script: |
            echo "$ENV_PRODUCTION" > /home/softengine/papers-api/.env.production
        env:
          ENV_PRODUCTION: ${{ secrets.ENV_PRODUCTION }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script_stop: true
          script: |
            cd /home/softengine/papers-api
            git reset --hard HEAD
            git clean -fd
            git pull origin main
            docker compose -f docker-compose.prod.yml build --no-cache api
            docker compose -f docker-compose.prod.yml up -d --force-recreate api
            sleep 10
            docker exec papers-api npx prisma migrate deploy
            sleep 5
            curl -sf http://localhost:8050/api/v1/health || exit 1
            echo "Deployment successful!"
