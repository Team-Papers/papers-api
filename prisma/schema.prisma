generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// USERS
// ==========================================

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  passwordHash  String?   @map("password_hash") @db.VarChar(255)
  googleId      String?   @unique @map("google_id") @db.VarChar(255)
  firstName     String?   @map("first_name") @db.VarChar(100)
  lastName      String?   @map("last_name") @db.VarChar(100)
  avatarUrl     String?   @map("avatar_url") @db.VarChar(500)
  role          Role      @default(READER)
  status        UserStatus @default(ACTIVE)
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  authorProfile    AuthorProfile?
  purchases        Purchase[]
  libraryBooks     UserLibrary[]
  bookmarks        Bookmark[]
  reviews          Review[]
  notifications    Notification[]
  reports          Report[]       @relation("Reporter")
  refreshTokens    RefreshToken[]
  authorFollows    AuthorFollower[]
  favorites        Favorite[]
  articleLikes     ArticleLike[]

  @@map("users")
}

enum Role {
  READER
  AUTHOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

// ==========================================
// REFRESH TOKENS
// ==========================================

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ==========================================
// AUTHOR PROFILES
// ==========================================

model AuthorProfile {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @unique @map("user_id") @db.Uuid
  penName     String?      @map("pen_name") @db.VarChar(100)
  bio         String?      @db.Text
  photoUrl    String?      @map("photo_url") @db.VarChar(500)
  website     String?      @db.VarChar(255)
  twitter     String?      @db.VarChar(100)
  facebook    String?      @db.VarChar(100)
  status      AuthorStatus @default(PENDING)
  mtnNumber   String?      @map("mtn_number") @db.VarChar(20)
  omNumber    String?      @map("om_number") @db.VarChar(20)
  balance     Decimal      @default(0) @db.Decimal(12, 2)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  books        Book[]
  transactions AuthorTransaction[]
  withdrawals  Withdrawal[]
  followers    AuthorFollower[]

  @@map("author_profiles")
}

enum AuthorStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==========================================
// AUTHOR FOLLOWERS
// ==========================================

model AuthorFollower {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  authorId  String   @map("author_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  author AuthorProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@unique([userId, authorId])
  @@index([authorId])
  @@map("author_followers")
}

// ==========================================
// CATEGORIES
// ==========================================

model Category {
  id          String     @id @default(uuid()) @db.Uuid
  name        String     @db.VarChar(100)
  slug        String     @unique @db.VarChar(100)
  description String?    @db.Text
  parentId    String?    @map("parent_id") @db.Uuid
  icon        String?    @db.VarChar(50)
  orderIndex  Int        @default(0) @map("order_index")
  createdAt   DateTime   @default(now()) @map("created_at")

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  books    BookCategory[]

  @@map("categories")
}

// ==========================================
// BOOKS
// ==========================================

model Book {
  id              String     @id @default(uuid()) @db.Uuid
  authorId        String     @map("author_id") @db.Uuid
  title           String     @db.VarChar(255)
  slug            String     @unique @db.VarChar(255)
  description     String?    @db.Text
  isbn            String?    @db.VarChar(20)
  language        String     @default("fr") @db.VarChar(10)
  pageCount       Int?       @map("page_count")
  price           Decimal    @db.Decimal(10, 2)
  coverUrl        String?    @map("cover_url") @db.VarChar(500)
  fileUrl         String?    @map("file_url") @db.VarChar(500)
  fileSize        BigInt?    @map("file_size")
  fileFormat      String?    @map("file_format") @db.VarChar(10)
  previewPercent  Int        @default(10) @map("preview_percent")
  status           BookStatus @default(DRAFT)
  rejectionReason  String?    @map("rejection_reason") @db.Text
  rejectionHistory Json?      @map("rejection_history")
  publishedAt      DateTime?  @map("published_at")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  author      AuthorProfile  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories  BookCategory[]
  collections CollectionBook[]
  purchases   Purchase[]
  libraryBooks UserLibrary[]
  bookmarks   Bookmark[]
  reviews     Review[]
  transactions AuthorTransaction[]
  favorites    Favorite[]

  @@index([authorId])
  @@index([status])
  @@index([slug])
  @@map("books")
}

enum BookStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PUBLISHED
}

// ==========================================
// BOOK CATEGORIES (Many-to-Many)
// ==========================================

model BookCategory {
  bookId     String @map("book_id") @db.Uuid
  categoryId String @map("category_id") @db.Uuid

  book     Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([bookId, categoryId])
  @@map("book_categories")
}

// ==========================================
// PURCHASES
// ==========================================

model Purchase {
  id            String         @id @default(uuid()) @db.Uuid
  userId        String         @map("user_id") @db.Uuid
  bookId        String         @map("book_id") @db.Uuid
  amount        Decimal        @db.Decimal(10, 2)
  paymentMethod String?        @map("payment_method") @db.VarChar(20)
  paymentRef    String?        @map("payment_ref") @db.VarChar(100)
  status        PurchaseStatus @default(PENDING)
  createdAt     DateTime       @default(now()) @map("created_at")

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  book         Book                @relation(fields: [bookId], references: [id], onDelete: Cascade)
  transactions AuthorTransaction[]

  @@index([userId])
  @@index([bookId])
  @@map("purchases")
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ==========================================
// USER LIBRARY
// ==========================================

model UserLibrary {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  bookId      String    @map("book_id") @db.Uuid
  progress    Decimal   @default(0) @db.Decimal(5, 2)
  currentPage Int       @default(0) @map("current_page")
  lastReadAt  DateTime? @map("last_read_at")
  downloaded  Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId])
  @@map("user_library")
}

// ==========================================
// FAVORITES
// ==========================================

model Favorite {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  bookId    String   @map("book_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId])
  @@index([bookId])
  @@map("favorites")
}

// ==========================================
// BOOKMARKS
// ==========================================

model Bookmark {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  bookId    String   @map("book_id") @db.Uuid
  page      Int
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@map("bookmarks")
}

// ==========================================
// REVIEWS
// ==========================================

model Review {
  id        String       @id @default(uuid()) @db.Uuid
  userId    String       @map("user_id") @db.Uuid
  bookId    String       @map("book_id") @db.Uuid
  rating    Int
  comment   String?      @db.Text
  status    ReviewStatus @default(VISIBLE)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([bookId])
  @@map("reviews")
}

enum ReviewStatus {
  VISIBLE
  HIDDEN
  REPORTED
}

// ==========================================
// AUTHOR TRANSACTIONS
// ==========================================

model AuthorTransaction {
  id         String            @id @default(uuid()) @db.Uuid
  authorId   String            @map("author_id") @db.Uuid
  type       TransactionType
  amount     Decimal           @db.Decimal(12, 2)
  commission Decimal           @default(0) @db.Decimal(12, 2)
  netAmount  Decimal           @map("net_amount") @db.Decimal(12, 2)
  reference  String?           @db.VarChar(100)
  bookId     String?           @map("book_id") @db.Uuid
  purchaseId String?           @map("purchase_id") @db.Uuid
  status     TransactionStatus @default(COMPLETED)
  createdAt  DateTime          @default(now()) @map("created_at")

  author   AuthorProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)
  book     Book?         @relation(fields: [bookId], references: [id])
  purchase Purchase?     @relation(fields: [purchaseId], references: [id])

  @@map("author_transactions")
}

enum TransactionType {
  SALE
  WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

// ==========================================
// WITHDRAWALS
// ==========================================

model Withdrawal {
  id              String           @id @default(uuid()) @db.Uuid
  authorId        String           @map("author_id") @db.Uuid
  amount          Decimal          @db.Decimal(12, 2)
  paymentMethod   String           @map("payment_method") @db.VarChar(20)
  phoneNumber     String           @map("phone_number") @db.VarChar(20)
  status          WithdrawalStatus @default(PENDING)
  rejectionReason String?          @map("rejection_reason") @db.Text
  processedAt     DateTime?        @map("processed_at")
  createdAt       DateTime         @default(now()) @map("created_at")

  author AuthorProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("withdrawals")
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
}

// ==========================================
// REPORTS
// ==========================================

model Report {
  id          String       @id @default(uuid()) @db.Uuid
  reporterId  String       @map("reporter_id") @db.Uuid
  type        ReportType
  targetId    String       @map("target_id") @db.Uuid
  reason      String       @db.VarChar(50)
  description String?      @db.Text
  status      ReportStatus @default(PENDING)
  adminNote   String?      @map("admin_note") @db.Text
  createdAt   DateTime     @default(now()) @map("created_at")

  reporter User @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@map("reports")
}

enum ReportType {
  BOOK
  REVIEW
  USER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(255)
  message   String?  @db.Text
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

// ==========================================
// COLLECTIONS
// ==========================================

model Collection {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(150)
  slug        String   @unique @db.VarChar(150)
  description String?  @db.Text
  imageUrl    String?  @map("image_url") @db.VarChar(500)
  orderIndex  Int      @default(0) @map("order_index")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  books CollectionBook[]

  @@map("collections")
}

// ==========================================
// COLLECTION BOOKS (Many-to-Many)
// ==========================================

model CollectionBook {
  collectionId String @map("collection_id") @db.Uuid
  bookId       String @map("book_id") @db.Uuid
  orderIndex   Int    @default(0) @map("order_index")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  book       Book       @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@id([collectionId, bookId])
  @@map("collection_books")
}

// ==========================================
// BLOG ARTICLES
// ==========================================

model Article {
  id            String        @id @default(uuid()) @db.Uuid
  title         String        @db.VarChar(255)
  slug          String        @unique @db.VarChar(255)
  content       String        @db.Text
  excerpt       String?       @db.VarChar(500)
  coverUrl      String?       @map("cover_url") @db.VarChar(500)
  category      String?       @db.VarChar(100)
  status        ArticleStatus @default(DRAFT)
  publishedAt   DateTime?     @map("published_at")
  likesCount    Int           @default(0) @map("likes_count")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  likes ArticleLike[]

  @@index([status])
  @@index([slug])
  @@map("articles")
}

model ArticleLike {
  id        String   @id @default(uuid()) @db.Uuid
  articleId String   @map("article_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId])
  @@index([userId])
  @@map("article_likes")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ==========================================
// PLATFORM SETTINGS
// ==========================================

model Setting {
  key       String   @id @db.VarChar(100)
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
